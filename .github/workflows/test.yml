name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install ShellCheck
      run: sudo apt-get install -y shellcheck
    
    - name: Run ShellCheck on backup script
      run: shellcheck -x backup-codium.sh
    
    - name: Run ShellCheck on restore script
      run: shellcheck -x restore-codium.sh
    
    - name: Run ShellCheck on tests
      run: shellcheck -x tests/test-all.sh

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check backup script syntax
      run: bash -n backup-codium.sh
    
    - name: Check restore script syntax
      run: bash -n restore-codium.sh
    
    - name: Check test script syntax
      run: bash -n tests/test-all.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Make scripts executable
      run: |
        chmod +x backup-codium.sh
        chmod +x restore-codium.sh
        chmod +x tests/test-all.sh
    
    - name: Run test suite
      run: bash tests/test-all.sh
      continue-on-error: false

  help-check:
    name: Help Output Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Make scripts executable
      run: |
        chmod +x backup-codium.sh
        chmod +x restore-codium.sh
    
    - name: Check backup script help
      run: ./backup-codium.sh --help | grep -q "USAGE"
    
    - name: Check restore script help
      run: ./restore-codium.sh --help | grep -q "USAGE"
    
    - name: Check backup script version
      run: ./backup-codium.sh --version | grep -q "v"
    
    - name: Check restore script version
      run: ./restore-codium.sh --version | grep -q "v"

  dry-run-test:
    name: Dry-Run Execution Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Make scripts executable
      run: |
        chmod +x backup-codium.sh
        chmod +x restore-codium.sh
    
    - name: Test backup dry-run
      run: ./backup-codium.sh --dry-run --verbose
      continue-on-error: true
    
    - name: Test restore dry-run
      run: ./restore-codium.sh --dry-run --verbose --skip-verify
      continue-on-error: true

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for TODO comments
      run: |
        if grep -r "TODO" backup-codium.sh restore-codium.sh; then
          echo "Found TODO comments - consider addressing them"
        else
          echo "No TODO comments found"
        fi
      continue-on-error: true
    
    - name: Check for placeholder values
      run: |
        if grep -r "FIXME\|XXX\|HACK" backup-codium.sh restore-codium.sh; then
          echo "Found FIXME/XXX/HACK comments"
        else
          echo "No FIXME/XXX/HACK comments found"
        fi
      continue-on-error: true

  summary:
    name: Test Summary
    needs: [shellcheck, syntax-check, unit-tests, help-check, dry-run-test, code-quality]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "✓ All checks completed"
        echo "✓ ShellCheck: Passed"
        echo "✓ Syntax Check: Passed"
        echo "✓ Unit Tests: Passed"
        echo "✓ Help Output: Passed"
        echo "✓ Dry-Run: Completed"
        echo "✓ Code Quality: Checked"
